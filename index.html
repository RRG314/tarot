<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>RDT PRNG Test</title>
<style>
  body {
    margin: 0;
    background: #0b0b0b;
    color: #ddd;
    font-family: monospace;
    overflow: hidden;
  }
  #info {
    position: fixed;
    top: 10px;
    left: 10px;
    background: rgba(0,0,0,0.6);
    padding: 10px;
    border-radius: 6px;
  }
</style>
</head>
<body>

<div id="info">
  <div><b>RDT-PRNG active</b></div>
  <div>Seed via <code>?seed=123</code> or <code>?seed=0xdeadbeef</code></div>
</div>

<canvas id="c"></canvas>

<script>
/* ============================================================
   RDT-based PRNG (ported from your C core)
   ============================================================ */

const RDT_PRNG = (() => {
  const MASK64 = (1n << 64n) - 1n;

  function rotl64(x, r) {
    r &= 63n;
    return ((x << r) | (x >> (64n - r))) & MASK64;
  }

  function popcount64(x) {
    let c = 0n;
    while (x) { c += x & 1n; x >>= 1n; }
    return c;
  }

  function bitLength64(x) {
    let n = 0n;
    while (x) { n++; x >>= 1n; }
    return n;
  }

  function rdt_depth_fast(x) {
    const bl = bitLength64(x);
    const pc = popcount64(x);
    const mid = bl ? (x >> (bl >> 1n)) : 0n;
    return Number((bl ^ (pc << 1n) ^ mid) & 63n);
  }

  function isqrt32(x) {
    let r = 0, bit = 1 << 30;
    while (bit > x) bit >>= 2;
    while (bit !== 0) {
      if (x >= r + bit) { x -= r + bit; r += bit << 1; }
      r >>= 1;
      bit >>= 2;
    }
    return r;
  }

  function scalar_field(x) {
    const a = Number(x & 0xFFFFn);
    const b = Number((x >> 16n) & 0xFFFFn);
    const t = isqrt32(a*a + b*b);
    return rdt_depth_fast(BigInt(t));
  }

  const P = [3n,5n,7n,11n,13n,17n,19n];

  function rdt_mix(x, K) {
    x &= MASK64;
    const d = rdt_depth_fast(x);
    const g = scalar_field(x);

    let m = (x + BigInt(g)) * 0x9E3779B97F4A7C15n & MASK64;
    let p = m ^ (BigInt(d) * 0xBF58476D1CE4E5B9n & MASK64);

    let eps = 0n;
    const rounds = d < 6 ? d : 6;
    for (let i = 0; i <= rounds; i++) {
      let c = p * (P[i] * 0xC2B2AE3D27D4EB4Fn & MASK64) & MASK64;
      c ^= (p >> BigInt(i + 1)) * P[i] & MASK64;
      c ^= K[i & 3];
      c = rotl64(c, BigInt(13 + 7*i));
      eps ^= c;
    }

    let z = p ^ eps;
    const ROT = [13n,23n,43n];
    const MUL = [19n,29n,47n];

    const rp = ROT[d % 3];
    const mp = MUL[d % 3] * 0xD6E8FEB86659FD93n & MASK64;

    z ^= (z << rp) & MASK64;
    z ^= z >> (rp >> 1n);
    z = (z * mp) & MASK64;
    z ^= K[(d ^ Number(rp)) & 3];

    return rotl64(z, BigInt(d) ^ rp);
  }

  let K = [
    0xA5A5A5A5A5A5A5A5n,
    0x0123456789ABCDEFn,
    0x9E3779B97F4A7C15n,
    0xC2B2AE3D27D4EB4Fn
  ];
  let V = 1n;

  function seed(s) {
    let x = BigInt(s) & MASK64;
    for (let i = 0; i < 4; i++) {
      x ^= x >> 12n;
      x ^= x << 25n;
      x ^= x >> 27n;
      K[i] = (x * 0x2545F4914F6CDD1Dn) & MASK64;
    }
    V = x ^ 0xDEADBEEFCAFEBABEn;
  }

  return {
    seedFromURL() {
      const p = new URLSearchParams(location.search).get("seed");
      if (p) seed(p.startsWith("0x") ? BigInt(p) : BigInt(parseInt(p)));
      else if (crypto?.getRandomValues) {
        const b = new BigUint64Array(1);
        crypto.getRandomValues(b);
        seed(b[0]);
      } else seed(Date.now());
    },

    u64() {
      V = (V + 1n) & MASK64;
      return rdt_mix(V ^ K[0], K);
    },

    random() {
      return Number(this.u64() >> 11n) / 2**53;
    },

    int(n) {
      let x;
      const lim = (1n << 64n) - ((1n << 64n) % BigInt(n));
      do { x = this.u64(); } while (x >= lim);
      return Number(x % BigInt(n));
    }
  };
})();

RDT_PRNG.seedFromURL();

/* ============================================================
   Demo: visual proof PRNG works
   ============================================================ */

const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");

function resize() {
  canvas.width = innerWidth;
  canvas.height = innerHeight;
}
addEventListener("resize", resize);
resize();

function draw() {
  ctx.fillStyle = "rgba(0,0,0,0.25)";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  for (let i = 0; i < 200; i++) {
    const x = RDT_PRNG.random() * canvas.width;
    const y = RDT_PRNG.random() * canvas.height;
    const r = 1 + RDT_PRNG.int(3);

    ctx.fillStyle = `hsl(${RDT_PRNG.int(360)},80%,60%)`;
    ctx.beginPath();
    ctx.arc(x,y,r,0,Math.PI*2);
    ctx.fill();
  }

  requestAnimationFrame(draw);
}

draw();
</script>
</body>
</html>
